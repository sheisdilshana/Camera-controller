<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CinePrompt Pro | Studio Grade</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. SYSTEM & VARIABLES --- */
        :root {
            --accent: #00E5FF;
            --accent-glow: rgba(0, 229, 255, 0.4);
            --record-red: #FF3B30;
            --surface: rgba(20, 20, 20, 0.85);
            --surface-solid: #121212;
            --text-main: #FFFFFF;
            --text-muted: #A0A0A0;
            --font-stack: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; 
            background: #000; color: var(--text-main); 
            font-family: var(--font-stack); 
            overflow: hidden; height: 100dvh; 
        }

        /* --- 2. UI UTILITIES --- */
        .hidden { display: none !important; }
        .glass-panel {
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        button { cursor: pointer; font-family: inherit; user-select: none; }
        
        /* --- 3. LAYER: SETUP (HOME) --- */
        #view-setup {
            position: fixed; inset: 0; z-index: 50;
            background: var(--surface-solid);
            padding: calc(var(--safe-top) + 20px) 24px var(--safe-bottom);
            display: flex; flex-direction: column;
            overflow-y: auto;
        }

        .brand-header { margin-bottom: 24px; }
        .brand-header h1 { font-size: 1.8rem; font-weight: 800; margin: 0; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-header p { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }

        .input-group { margin-bottom: 20px; }
        .input-label { display: block; color: var(--accent); font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; }
        
        textarea {
            width: 100%; height: 180px;
            background: #1A1A1A; border: 1px solid #333; border-radius: 16px;
            color: #fff; padding: 16px; font-size: 1.1rem; line-height: 1.6;
            resize: none; outline: none; transition: 0.2s;
        }
        textarea:focus { border-color: var(--accent); }

        select {
            width: 100%; padding: 14px;
            background: #1A1A1A; border: 1px solid #333; border-radius: 12px;
            color: #fff; font-size: 1rem; outline: none; appearance: none;
        }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .toggle-btn {
            background: #1A1A1A; border: 1px solid #333; padding: 12px;
            border-radius: 12px; color: var(--text-muted); font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .toggle-btn.active { background: rgba(0, 229, 255, 0.15); border-color: var(--accent); color: var(--accent); }

        .btn-primary {
            width: 100%; padding: 20px;
            background: var(--accent); color: #000;
            border: none; border-radius: 16px;
            font-size: 1.1rem; font-weight: 800; margin-top: auto;
            box-shadow: 0 4px 20px var(--accent-glow);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* --- 4. LAYER: STUDIO (CAMERA) --- */
        #view-studio { position: fixed; inset: 0; z-index: 40; background: #000; display: none; }
        
        /* Video Feed */
        #video-preview-layer {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); /* User sees mirror */
        }

        /* Teleprompter Overlay */
        #prompter-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: hidden;
            /* Gradient: Dark at top for readability, fades to transparent */
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 30%, transparent 100%);
        }

        /* The scrolling text container */
        #prompter-scroll-container {
            width: 90%; max-width: 600px; margin: 0 auto;
            position: relative;
            /* Critical: Text starts near camera (top 15%) */
            padding-top: 15vh; padding-bottom: 80vh;
        }

        #prompter-text {
            color: #fff; font-weight: 700; line-height: 1.6;
            text-align: center; text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            will-change: transform;
        }

        /* Active Reading Line Marker (Visual Aid) */
        .eye-line-marker {
            position: absolute; top: 18vh; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.3; z-index: 5;
        }

        /* Controls UI */
        #studio-ui {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .top-bar {
            padding: calc(var(--safe-top) + 15px) 20px;
            display: flex; justify-content: space-between; pointer-events: auto;
        }
        .close-btn { background: rgba(0,0,0,0.5); color: #fff; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; }

        .bottom-controls {
            pointer-events: auto;
            padding: 20px 20px calc(var(--safe-bottom) + 20px);
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }

        .slider-row {
            display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px;
        }
        .slider-label { font-size: 0.7rem; color: #aaa; width: 40px; text-align: right; }
        input[type=range] { flex: 1; max-width: 200px; accent-color: var(--accent); height: 4px; }

        .action-row {
            display: flex; align-items: center; justify-content: space-evenly;
        }

        /* Action Buttons */
        .btn-round {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: #fff; background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px); transition: 0.2s;
        }
        .btn-round:active { transform: scale(0.9); }

        .btn-shutter-ring {
            width: 78px; height: 78px; border: 4px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: transparent; cursor: pointer;
        }
        .btn-shutter-inner {
            width: 60px; height: 60px; background: var(--record-red);
            border-radius: 50%; transition: 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        /* Recording State */
        .is-recording .btn-shutter-inner { width: 30px; height: 30px; border-radius: 6px; }
        .is-recording .top-bar { opacity: 0; pointer-events: none; } /* Hide distractions */
        .is-recording .slider-row { opacity: 0.3; pointer-events: none; } /* Dim sliders */

        /* --- 5. OVERLAYS (Countdown & Review) --- */
        #overlay-countdown {
            position: absolute; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            font-size: 8rem; font-weight: 800; color: #fff;
        }

        #view-review {
            position: fixed; inset: 0; z-index: 60; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #review-player { width: 100%; max-height: 80vh; }
        .review-actions {
            width: 100%; display: flex; gap: 10px; padding: 20px;
            position: absolute; bottom: 0; background: #111;
        }
        .btn-discard { background: #333; color: #fff; flex: 1; padding: 15px; border-radius: 12px; border:none; font-weight: 600; }
        .btn-save-gallery { background: var(--accent); color: #000; flex: 2; padding: 15px; border-radius: 12px; border:none; font-weight: 800; }

    </style>
</head>
<body>

    <!-- === LAYER 1: SETUP === -->
    <div id="view-setup">
        <div class="brand-header">
            <h1>CinePrompt Pro</h1>
            <p>The Ultimate Mobile Teleprompter</p>
        </div>

        <!-- Audio Select -->
        <div class="input-group">
            <span class="input-label">Microphone Source</span>
            <select id="sel-audio"></select>
        </div>

        <!-- Script Input -->
        <div class="input-group">
            <span class="input-label">Script</span>
            <textarea id="inp-script" placeholder="Paste your script here... Top tip: Keep lines short for better flow."></textarea>
        </div>

        <!-- Settings Grid -->
        <div class="input-group settings-grid">
            <button class="toggle-btn active" id="btn-res-hd" onclick="setResolution('hd')">1080p Smooth</button>
            <button class="toggle-btn" id="btn-res-4k" onclick="setResolution('4k')">4K Ultra</button>
        </div>
        
        <p style="font-size: 0.75rem; color: #666; margin-bottom: 20px; line-height: 1.4;">
            * 4K requires good lighting. <br>
            * Text is placed at the top for eye contact.
        </p>

        <button class="btn-primary" onclick="launchStudio()">OPEN STUDIO</button>
    </div>

    <!-- === LAYER 2: STUDIO === -->
    <div id="view-studio">
        <!-- Live Camera Feed -->
        <video id="video-preview-layer" autoplay playsinline muted></video>

        <!-- Prompter Overlay -->
        <div id="prompter-zone">
            <div class="eye-line-marker"></div> <!-- Helps user look at camera -->
            <div id="prompter-scroll-container">
                <div id="prompter-text"></div>
            </div>
        </div>

        <!-- Controls Layer -->
        <div id="studio-ui">
            <!-- Top: Exit -->
            <div class="top-bar">
                <button class="close-btn" onclick="exitStudio()">‚úï Exit</button>
                <div style="color:red; font-weight:bold; opacity:0; transition:0.3s" id="rec-dot">‚óè REC</div>
            </div>

            <!-- Bottom: Controls -->
            <div class="bottom-controls">
                
                <!-- Sliders -->
                <div class="slider-row">
                    <span class="slider-label">SIZE</span>
                    <input type="range" id="rng-size" min="1.5" max="4.5" step="0.1" value="2.5">
                </div>
                <div class="slider-row">
                    <span class="slider-label">SPEED</span>
                    <input type="range" id="rng-speed" min="0" max="5" step="0.1" value="1.5">
                </div>

                <!-- Main Actions -->
                <div class="action-row">
                    <!-- Reset Text -->
                    <button class="btn-round" onclick="resetTeleprompter()">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    </button>

                    <!-- Shutter -->
                    <div class="btn-shutter-ring" onclick="toggleRecording()">
                        <div class="btn-shutter-inner"></div>
                    </div>

                    <!-- Stop/Done -->
                    <button class="btn-round" onclick="finishRecording()" style="background:var(--accent); color:#000;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Countdown Overlay -->
        <div id="overlay-countdown" class="hidden">3</div>
    </div>

    <!-- === LAYER 3: REVIEW === -->
    <div id="view-review" class="hidden">
        <video id="review-player" controls playsinline loop></video>
        <div class="review-actions">
            <button class="btn-discard" onclick="discardTake()">üóë Discard</button>
            <button class="btn-save-gallery" onclick="saveToDevice()">‚¨á Save to Gallery</button>
        </div>
    </div>

    <script>
        /**
         * CINEPROMPT PRO - CORE LOGIC
         */
        
        // --- VARIABLES ---
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let finalBlob = null;
        
        // Prompter Engine
        let isScrolling = false;
        let scrollY = 0;
        let scrollSpeed = 1.5;
        let animationFrameId = null;
        let startTime = 0;
        
        // Settings
        let resolution = 'hd'; // 'hd' or '4k'
        let selectedAudioId = '';
        
        // DOM Elements
        const elSetup = document.getElementById('view-setup');
        const elStudio = document.getElementById('view-studio');
        const elReview = document.getElementById('view-review');
        const elVideo = document.getElementById('video-preview-layer');
        const elText = document.getElementById('prompter-text');
        const elRecDot = document.getElementById('rec-dot');
        const elCountdown = document.getElementById('overlay-countdown');

        // --- 1. INITIALIZATION & PERMISSIONS ---
        
        // Check for permission early to populate mics
        async function checkPermissions() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                populateAudioSources();
            } catch (e) {
                console.log("Permission not granted yet.");
            }
        }

        async function populateAudioSources() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioSelect = document.getElementById('sel-audio');
            audioSelect.innerHTML = '';
            
            const audioDevices = devices.filter(device => device.kind === 'audioinput');
            
            if (audioDevices.length === 0) {
                const opt = document.createElement('option');
                opt.text = "Default Microphone";
                audioSelect.appendChild(opt);
            }

            audioDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Microphone ${audioSelect.length + 1}`;
                audioSelect.appendChild(option);
            });
        }
        
        // Run on load
        checkPermissions();

        // UI Toggles
        function setResolution(res) {
            resolution = res;
            document.getElementById('btn-res-hd').classList.toggle('active', res === 'hd');
            document.getElementById('btn-res-4k').classList.toggle('active', res === '4k');
        }

        // --- 2. LAUNCH STUDIO ---
        
        async function launchStudio() {
            const script = document.getElementById('inp-script').value;
            if(!script.trim()) return alert("Please enter a script.");
            
            selectedAudioId = document.getElementById('sel-audio').value;
            
            // Set text
            elText.innerHTML = script.replace(/\n/g, "<br>");
            
            // UI Switch
            elSetup.classList.add('hidden');
            elStudio.style.display = 'block';

            // Constraint Logic
            const constraints = {
                audio: selectedAudioId ? { deviceId: { exact: selectedAudioId } } : true,
                video: {
                    facingMode: 'user',
                    width: resolution === '4k' ? { ideal: 3840 } : { ideal: 1920 },
                    height: resolution === '4k' ? { ideal: 2160 } : { ideal: 1080 },
                    frameRate: { ideal: 30 }
                }
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                elVideo.srcObject = stream;
                
                // Wake Lock (Keep screen on)
                if ('wakeLock' in navigator) {
                    try { await navigator.wakeLock.request('screen'); } catch(e){}
                }

            } catch (err) {
                alert("Camera Error: " + err.message);
                exitStudio();
            }
        }

        function exitStudio() {
            if(stream) stream.getTracks().forEach(track => track.stop());
            elStudio.style.display = 'none';
            elSetup.classList.remove('hidden');
            cancelAnimationFrame(animationFrameId);
        }

        // --- 3. RECORDING LOGIC ---

        function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                // Determine if we should pause or stop. 
                // For simplicity in this UX, pressing the button again PAUSES.
                // The 'Checkmark' button STOPS.
                pauseRecording();
            } else {
                startCountdownAndRecord();
            }
        }

        function startCountdownAndRecord() {
            if (mediaRecorder && mediaRecorder.state === "paused") {
                resumeRecording();
                return;
            }

            // Fresh Start
            elCountdown.classList.remove('hidden');
            let count = 3;
            elCountdown.innerText = count;

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    elCountdown.innerText = count;
                } else {
                    clearInterval(timer);
                    elCountdown.classList.add('hidden');
                    beginCapture();
                }
            }, 1000);
        }

        function beginCapture() {
            recordedChunks = [];
            
            // Codec Support
            const options = MediaRecorder.isTypeSupported('video/mp4; codecs=avc1') 
                ? { mimeType: 'video/mp4; codecs=avc1' } 
                : { mimeType: 'video/webm' };

            mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = (e) => {
                if(e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.start(1000); // 1s timeslices to prevent RAM crash spikes
            
            document.body.classList.add('is-recording');
            elRecDot.style.opacity = 1;
            
            startScrolling();
        }

        function pauseRecording() {
            mediaRecorder.pause();
            stopScrolling();
            document.body.classList.remove('is-recording'); // Bring back controls
            elRecDot.style.opacity = 0; // Blink logic could be added here
            alert("Paused. Press Red Button to Resume or Checkmark to Finish.");
        }

        function resumeRecording() {
            mediaRecorder.resume();
            startScrolling();
            document.body.classList.add('is-recording');
            elRecDot.style.opacity = 1;
        }

        function finishRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return alert("No recording found.");
            
            mediaRecorder.onstop = () => {
                const mimeType = mediaRecorder.mimeType;
                finalBlob = new Blob(recordedChunks, { type: mimeType });
                
                // Show Review
                const url = URL.createObjectURL(finalBlob);
                document.getElementById('review-player').src = url;
                elStudio.style.display = 'none';
                elReview.classList.remove('hidden');
                
                // Cleanup
                stopScrolling();
                document.body.classList.remove('is-recording');
                elRecDot.style.opacity = 0;
            };

            mediaRecorder.stop();
        }

        // --- 4. SCROLL ENGINE (High Perf) ---

        function startScrolling() {
            if(isScrolling) return;
            isScrolling = true;
            let lastTime = performance.now();

            function step(currentTime) {
                if (!isScrolling) return;
                
                const delta = currentTime - lastTime;
                const speedSetting = parseFloat(document.getElementById('rng-speed').value);
                
                // Speed calculation: pixels per frame
                if (speedSetting > 0) {
                    scrollY -= (speedSetting * (delta / 16)); 
                    elText.style.transform = `translateY(${scrollY}px)`;
                }
                
                lastTime = currentTime;
                animationFrameId = requestAnimationFrame(step);
            }
            
            animationFrameId = requestAnimationFrame(step);
        }

        function stopScrolling() {
            isScrolling = false;
            cancelAnimationFrame(animationFrameId);
        }

        function resetTeleprompter() {
            stopScrolling();
            scrollY = 0;
            elText.style.transform = `translateY(0px)`;
        }

        // --- 5. REVIEW & SAVE ---

        function discardTake() {
            if(confirm("Discard this video?")) {
                URL.revokeObjectURL(document.getElementById('review-player').src);
                elReview.classList.add('hidden');
                elStudio.style.display = 'block';
                resetTeleprompter();
                recordedChunks = [];
            }
        }

        function saveToDevice() {
            if(!finalBlob) return;
            
            const url = URL.createObjectURL(finalBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // Format Filename: CinePrompt_YYYY-MM-DD_HH-MM.mp4
            const date = new Date();
            const timestamp = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}_${date.getHours()}-${date.getMinutes()}`;
            
            const ext = finalBlob.type.includes('mp4') ? 'mp4' : 'webm';
            a.download = `CinePrompt_${timestamp}.${ext}`;
            
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert("Video Saved! Check your Photos or Files app.");
            }, 100);
        }

        // --- 6. UTILITIES ---
        document.getElementById('rng-size').addEventListener('input', (e) => {
            elText.style.fontSize = e.target.value + 'rem';
        });

    </script>
</body>
</html>
