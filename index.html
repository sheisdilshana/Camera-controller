<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CinePrompt | Native 4K</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+Kannada:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* RESET & BASICS */
        body { margin: 0; background: #000; color: #fff; font-family: 'Inter', 'Noto Sans Kannada', sans-serif; overflow: hidden; height: 100vh; }
        
        /* FULLSCREEN VIDEO - NO FILTERS */
        #camera-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; background: #000;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); /* Mirror effect only for preview */
        }

        /* TEXT OVERLAY LAYER */
        #script-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; justify-content: center;
            /* Clean fade mask */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 65%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 65%, transparent 100%);
        }

        #scrolling-text {
            width: 90%; max-width: 500px; text-align: center;
            font-size: 2rem; font-weight: 700; line-height: 1.5;
            color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            /* START POSITION: 15% from top */
            padding-top: 15vh; padding-bottom: 80vh;
            transform: translateY(0); will-change: transform;
        }

        /* UI CONTROLS LAYER */
        #ui-layer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none; /* Let clicks pass through to empty areas */
            display: flex; flex-direction: column; justify-content: flex-end;
        }

        .control-bar {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6); /* Simple dark bg, no blurry noise */
            padding: 20px;
            display: flex; align-items: center; justify-content: space-between;
            padding-bottom: 40px;
        }

        /* BUTTONS */
        .rec-btn-outer {
            width: 76px; height: 76px; border: 4px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .rec-btn-inner {
            width: 60px; height: 60px; background: #ff0000; border-radius: 50%; transition: 0.2s;
        }
        .recording .rec-btn-inner { transform: scale(0.5); border-radius: 6px; }

        .reshoot-btn {
            background: #222; border: 1px solid #444; color: #fff;
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; pointer-events: auto;
            opacity: 0; transition: 0.3s;
        }
        .show-reshoot { opacity: 1; }

        /* INPUTS */
        input[type=range] { width: 80px; accent-color: #ff0000; }
        .label { font-size: 10px; text-transform: uppercase; color: #ccc; text-align: center; margin-bottom: 5px; }

        /* SETUP SCREEN */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 50; padding: 30px;
            display: flex; flex-direction: column;
        }
        textarea {
            width: 100%; flex: 1; background: #222; border: 1px solid #333;
            color: #fff; font-size: 18px; padding: 15px; border-radius: 10px;
            margin: 20px 0; resize: none; outline: none;
        }
        .big-btn {
            background: #fff; color: #000; border: none; padding: 15px;
            font-weight: bold; font-size: 18px; border-radius: 10px; width: 100%;
        }
        .exit-btn {
            position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5);
            color: #fff; border: 1px solid #fff; padding: 5px 15px; border-radius: 20px;
            pointer-events: auto; font-size: 12px; z-index: 100;
        }
    </style>
</head>
<body>

    <!-- SETUP SCREEN -->
    <div id="setup-screen">
        <h2 style="margin:0;">New Project</h2>
        <p style="color:#666; font-size:12px; margin-top:5px;">Paste your script below</p>
        <textarea id="script-box" placeholder="Start typing..."></textarea>
        <button class="big-btn" onclick="openCamera()">Start Camera</button>
    </div>

    <!-- MAIN STUDIO -->
    <div id="studio-screen" style="display:none;">
        <button class="exit-btn" onclick="location.reload()">Exit</button>

        <div id="camera-view">
            <video id="vid" autoplay playsinline muted></video>
        </div>

        <div id="script-layer">
            <div id="scrolling-text"></div>
        </div>

        <div id="ui-layer">
            <div class="control-bar">
                <!-- Speed -->
                <div>
                    <div class="label">Speed</div>
                    <input type="range" id="speed-range" min="0" max="4" step="0.1" value="0.5">
                </div>

                <!-- Record Actions -->
                <div style="display:flex; align-items:center; gap: 20px;">
                    <div id="btn-reshoot" class="reshoot-btn" onclick="doReshoot()">â†º</div>
                    
                    <div class="rec-btn-outer" id="btn-record" onclick="toggleRecord()">
                        <div class="rec-btn-inner"></div>
                    </div>
                </div>

                <!-- Font Size -->
                <div>
                    <div class="label">Size</div>
                    <input type="range" id="size-range" min="1.5" max="4.0" step="0.1" value="2.2">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let stream, recorder, chunks = [];
        let scrollY = 0, scrollInterval;
        let isRecording = false;
        
        const vid = document.getElementById('vid');
        const textDiv = document.getElementById('scrolling-text');
        const recBtn = document.getElementById('btn-record');
        const reshootBtn = document.getElementById('btn-reshoot');

        // --- CAMERA SETUP (RAW QUALITY) ---
        async function openCamera() {
            const script = document.getElementById('script-box').value;
            if(!script) return alert("Please enter a script");
            
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('studio-screen').style.display = 'block';
            textDiv.innerText = script;

            // NATIVE CONSTRAINTS: 
            // We ask for 4K. If the phone can't do it, it gives the best it has.
            // We DO NOT set frameRate. We let the phone decide (Auto-Exposure).
            // This fixes the "Grain/Noise" issue in dark rooms.
            const constraints = {
                audio: true,
                video: {
                    facingMode: "user",
                    width: { ideal: 4096 }, 
                    height: { ideal: 2160 } 
                }
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                vid.srcObject = stream;
            } catch (err) {
                alert("Camera Error: " + err.message);
                location.reload();
            }
        }

        // --- SCROLLING ---
        function startScroll() {
            clearInterval(scrollInterval);
            scrollInterval = setInterval(() => {
                const speed = parseFloat(document.getElementById('speed-range').value);
                if(speed > 0) {
                    scrollY -= speed;
                    textDiv.style.transform = `translateY(${scrollY}px)`;
                }
            }, 16);
        }

        function stopScroll() { clearInterval(scrollInterval); }

        // --- RECORDING ---
        function toggleRecord() {
            if(isRecording) {
                // FINISH
                finishRecording();
            } else {
                // START
                startRecording();
            }
        }

        function startRecording() {
            chunks = [];
            
            // Prefer MP4 for better Android/iPhone compatibility
            let options = { mimeType: 'video/mp4' };
            if (!MediaRecorder.isTypeSupported('video/mp4')) {
                options = { mimeType: 'video/webm' };
            }

            try {
                recorder = new MediaRecorder(stream, options);
            } catch(e) {
                recorder = new MediaRecorder(stream); // Fallback
            }

            recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = saveVideo;
            
            recorder.start();
            isRecording = true;
            recBtn.classList.add('recording');
            reshootBtn.classList.add('show-reshoot');
            startScroll();
        }

        function finishRecording() {
            if(recorder && recorder.state !== 'inactive') recorder.stop();
            isRecording = false;
            recBtn.classList.remove('recording');
            reshootBtn.classList.remove('show-reshoot');
            stopScroll();
        }

        // --- RESHOOT (CANCEL) ---
        function doReshoot() {
            // Stop recorder but disconnect the save function
            recorder.onstop = null; 
            recorder.stop();
            
            isRecording = false;
            recBtn.classList.remove('recording');
            reshootBtn.classList.remove('show-reshoot');
            stopScroll();
            
            // Reset Text
            scrollY = 0;
            textDiv.style.transform = `translateY(0)`;
            
            // Feedback
            const oldText = textDiv.innerText;
            textDiv.innerText = "Reseting...";
            setTimeout(() => textDiv.innerText = oldText, 500);
        }

        function saveVideo() {
            const blob = new Blob(chunks, { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `Selfie_Video_${Date.now()}.mp4`;
            document.body.appendChild(a);
            a.click();
            
            // Reset
            scrollY = 0;
            textDiv.style.transform = `translateY(0)`;
            alert("Video saved to Gallery");
        }

        // --- SETTINGS ---
        document.getElementById('size-range').addEventListener('input', (e) => {
            textDiv.style.fontSize = e.target.value + 'rem';
        });
        
        document.getElementById('speed-range').addEventListener('input', () => {
             if(isRecording) startScroll();
        });

    </script>
</body>
</html>
